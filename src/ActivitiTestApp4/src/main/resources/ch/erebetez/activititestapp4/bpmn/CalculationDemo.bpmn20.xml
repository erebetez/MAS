<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema"
    expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.erebetez.ch/mainProcess">
    
    <process id="calculationDemo" name="Start a demo calculation application">

        <startEvent id="theStart" />

        <sequenceFlow id="flowfromStart" sourceRef="theStart"
            targetRef="usertask_inputValues" />

        <userTask id="usertask_inputValues" name="Input some numbers"
            activiti:formKey="inputCalculationValues">

            <documentation textFormat="text/plain">
                Provide some numbers for the calculation
            </documentation>

            <extensionElements>

                <activiti:formProperty id="value01" name="Value 01"
                    required="true" type="long" />
                <activiti:formProperty id="value02" name="Value 02"
                    required="true" type="long" />
                <activiti:formProperty id="value03" name="Value 02"
                    required="true" type="long" />
            </extensionElements>
            
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>
                        group(analysts), group(labmanagers)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <sequenceFlow id="flowToAutoScript" sourceRef="usertask_inputValues"
            targetRef="scripttask_createCalucationObject" />

        <scriptTask
            id="scripttask_createCalucationObject"
            name="makeArray"
            scriptFormat="groovy" >

            <script>
                execution.setVariable("appName", "A301.1");
            
                def valueList = [value01, value02, value03]
                
                def sessionVariable = [values:valueList, result:"none"]
                
                //out:println "calculationObject " + sessionVariable;                
                
                execution.setVariable("sessionVariable", sessionVariable);
            </script>
        </scriptTask>

        <sequenceFlow id="flowToCalc" sourceRef="scripttask_createCalucationObject"
            targetRef="callCalculationStarter" />

		<callActivity id="callCalculationStarter" calledElement="startExternApp" >
             <extensionElements>
                    <activiti:in source="appName" target="appName" />
                    <activiti:in source="sessionVariable" target="sessionVariable" />
                    <activiti:out source="sessionVariable" target="sessionVariable" />
             </extensionElements>
         </callActivity>

        <sequenceFlow id="flowToPrint" sourceRef="callCalculationStarter"
            targetRef="scripttask_print" />

        <scriptTask
            id="scripttask_print"
            name="Print Report"
            scriptFormat="groovy" >

            <script>
                fielpath = 'CalculationDemoOut.txt';
                
                out:println "Printing report to " + fielpath;
                
                def out = new File(fielpath);

                 try {

                    def valueList = sessionVariable[values];
               
	                out.append "Values" + '\n';
	                out.append valueList[0] + '\n';
	                out.append valueList[1] + '\n';
	                out.append valueList[2] + '\n';
	                out.append '\n';
	                
	                out.append "Result" + '\n';
	                out.append sessionVariable["result"] + '\n';
	                out.append '\n';
                } catch (MissingPropertyExceptionmpe) {
				    out.append "error";		   
				}
            </script>
        </scriptTask>

        <sequenceFlow id="flowToEnd" sourceRef="scripttask_print"
            targetRef="theEnd" />

        <endEvent id="theEnd" />

    </process>
</definitions>