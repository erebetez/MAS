<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema"
    expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.erebetez.ch/mainProcess">
    
    <process id="startInventory" name="Start the inventory check process">

        <startEvent id="theStart" />

        <sequenceFlow id="flowfromStart" sourceRef="theStart"
            targetRef="servicetask_getInventoryData" />

        <serviceTask id="servicetask_getInventoryData" name="Get Inventory Data"
            activiti:class="ch.erebetez.activititestapp4.bpmn.services.GetInventoryData" >
        </serviceTask>

        <sequenceFlow id="flowToGenerateItemTask" sourceRef="servicetask_getInventoryData"
            targetRef="callInventoryItem" />

		<callActivity id="callInventoryItem" calledElement="doInventoryItem" >
             <extensionElements>
                    <activiti:in source="itemDataParent" target="sessionVariable" />
<!--                   out not working for multi instances: http://jira.codehaus.org/browse/ACT-825 -->
<!--                     <activiti:out source="itemData" target="itemDataReturn" /> -->
             </extensionElements> 
             <multiInstanceLoopCharacteristics isSequential="false" >
			        <loopDataInputRef>InventoryData</loopDataInputRef>
					<inputDataItem name="itemDataParent" />
             </multiInstanceLoopCharacteristics>    
		</callActivity>

        <sequenceFlow id="flowToListCheck" sourceRef="callInventoryItem"
            targetRef="usertask_checkInventoryOverview" />

        <userTask id="usertask_checkInventoryOverview" name="Check the inventory Results"
            activiti:formKey="checkInventoryResultsForm">

            <documentation textFormat="text/plain">
                Check all is well.
            </documentation>

            <extensionElements>

                <activiti:formProperty id="checkComment" name="Check comment"
                    required="true" type="string" />
            </extensionElements>

            <potentialOwner>

                <resourceAssignmentExpression>

                    <formalExpression>
                        group(labmanagers)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <sequenceFlow id="flowToAutoScript" sourceRef="usertask_checkInventoryOverview"
            targetRef="scripttask_print" />

        <scriptTask
            id="scripttask_print"
            name="Print Report"
            scriptFormat="groovy" >

            <script>
                fielpath = 'InventoryTestOut.txt';
                
                out:println "Printing report to " + fielpath;
                
                def out = new File(fielpath);

                out.append "Comment " + checkComment;
                out.append '\n';
            </script>
        </scriptTask>

        <sequenceFlow id="flowToEnd" sourceRef="scripttask_print"
            targetRef="theEnd" />

        <endEvent id="theEnd" />

    </process>
</definitions>