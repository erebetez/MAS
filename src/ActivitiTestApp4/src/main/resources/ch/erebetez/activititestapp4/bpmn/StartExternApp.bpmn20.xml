<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
	xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
	xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema"
	expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.erebetez.ch/subProcess">

    <error id="noServerAvailable" errorCode="CalculationServerNotAvailable" />

	<process id="startExternApp" name="Starts an extern application">

		<startEvent id="theStart" />

		<sequenceFlow id="flowfromStart" sourceRef="theStart"
			targetRef="servicetask_externappadapter" />

		<serviceTask id="servicetask_externappadapter" name="Send Data to extern programm"
			activiti:delegateExpression="${externcalcadapter}">

			<!-- Not working yet. see http://forums.activiti.org/en/viewtopic.php?t=1662 -->
			<!-- <extensionElements> -->
			<!-- <activiti:field name="application" stringValue="A301.1" /> -->
			<!-- </extensionElements> -->
		</serviceTask>

		<sequenceFlow id="flowToEnd" sourceRef="servicetask_externappadapter"
			targetRef="theEnd" />

		<boundaryEvent id="noResponceError" cancelActivity="true"
			attachedToRef="servicetask_externappadapter">
			<errorEventDefinition errorRef="CalculationServerNotAvailable" />
		</boundaryEvent>

		<sequenceFlow id="flowError" sourceRef="noResponceError "
			targetRef="usertask_restartServer" />

		<!-- dummy user task, e-mail task might be the better choice -->
		<userTask id="usertask_restartServer" name="Server down"
			activiti:formKey="startOOS">

			<documentation textFormat="text/plain">
				No responce from Server.
				Please start it.
			</documentation>

			<!-- just reuse another form... -->
			<extensionElements>
				<activiti:formProperty id="oosNumber" name="OOS Number"
					required="true" type="string" />
			</extensionElements>

            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>
                        group(labmanagers)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
		</userTask>

		<sequenceFlow id="flowTimer2" sourceRef="usertask_restartServer"
			targetRef="servicetask_externappadapter" />

		<endEvent id="theEnd" />

	</process>
</definitions>