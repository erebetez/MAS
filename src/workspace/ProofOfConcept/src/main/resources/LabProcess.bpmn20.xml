<definitions xmlns:activiti="http://activiti.org/bpmn"
    id="definitions"
    targetNamespace="http://activiti.org/bpmn20"
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" >

    <process
        id="laborProcess"
        name="test_LaborProcess001" >

        <startEvent id="theStart" >

            <extensionElements>

                <activiti:formProperty
                    id="worklist"
                    name="Worklist"
                    required="true"
                    type="string" />
            </extensionElements>
        </startEvent>

        <sequenceFlow
            id="flow1"
            sourceRef="theStart"
            targetRef="usertask_getdata" />

        <userTask
            id="usertask_getdata"
            name="get data task" >

            <extensionElements>

                <activiti:formProperty
                    id="dilutionFactor"
                    name="Dilution factor"
                    required="true"
                    type="long" />
            </extensionElements>

            <potentialOwner>

                <resourceAssignmentExpression>

                    <formalExpression>
                        group(management)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <sequenceFlow
            id="flow2"
            sourceRef="usertask_getdata"
            targetRef="servicetask_getdataFromSDMS" />

        <serviceTask
            id="servicetask_getdataFromSDMS"
            activiti:class="ch.erebetez.mas.SdmsAdapter" >
        </serviceTask>

        <sequenceFlow
            id="flow3"
            sourceRef="servicetask_getdataFromSDMS"
            targetRef="scripttask_chooseCalc" />

        <scriptTask
            id="scripttask_chooseCalc"
            name="Print Report"
            scriptFormat="groovy" >

            <script>
                execution.setVariable("calcHost", "localhost");
                execution.setVariable("calcPort", 9998);
            </script>
        </scriptTask>

        <sequenceFlow
            id="flow4"
            sourceRef="scripttask_chooseCalc"
            targetRef="servicetask_calculate" />

        <serviceTask
            id="servicetask_calculate"
            activiti:class="ch.erebetez.mas.CalculationAdapter" >
        </serviceTask>

        <sequenceFlow
            id="flow5"
            sourceRef="servicetask_calculate"
            targetRef="scripttask_print" />

        <scriptTask
            id="scripttask_print"
            name="Print Report"
            scriptFormat="groovy" >

            <script>
				fielpath = '/tmp/lab_report_' + worklist + '.txt';
				
				out:println "Printing report to " + fielpath;
				
				def out = new File(fielpath);

			    out.append "Worklist " + worklist;
			    out.append '\n';

			    out.append "Dilutin factor " + dilutionFactor;
			    out.append '\n';

			    out.append "Raw data " + varB;
			    out.append '\n';
				
				out.append "Result " + varResult;
			    out.append '\n';

			    cmdLine = "firefox " + fielpath;

			    def process = cmdLine.execute();
            </script>
        </scriptTask>

        <sequenceFlow
            id="flow6"
            sourceRef="scripttask_print"
            targetRef="theEnd" />

        <endEvent id="theEnd" />
    </process>

</definitions>