<definitions xmlns:activiti="http://activiti.org/bpmn"
    id="definitions"
    targetNamespace="http://activiti.org/bpmn20"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
    xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"     
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" >

    <process
        id="laborProcess001"
        name="Proben Verd端nnung" >

        <startEvent id="theStart" >

            <extensionElements>

                <activiti:formProperty
                    id="worklist"
                    name="Worklist"
                    required="true"
                    type="string" />
            </extensionElements>
        </startEvent>

        <sequenceFlow
            id="flow1"
            sourceRef="theStart"
            targetRef="usertask_getdata" />

        <userTask
            id="usertask_getdata"
            name="Aufarbeitung Protokollieren" >

            <documentation textFormat="text/plain" >
               Bitte Probe f端r die ${worklist} verd端nnen.                
               Verd端nnungsfaktor im Formular angeben.                
            </documentation>

            <extensionElements>

                <activiti:formProperty
                    id="dilutionFactor"
                    name="Dilution factor"
                    required="true"
                    type="long" />
            </extensionElements>

            <potentialOwner>

                <resourceAssignmentExpression>

                    <formalExpression>
                        group(management)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <sequenceFlow
            id="flow2"
            sourceRef="usertask_getdata"
            targetRef="servicetask_getdataFromSDMS" />

        <serviceTask
            id="servicetask_getdataFromSDMS"
            name="SDMS Adapter"
            activiti:class="ch.erebetez.mas.SdmsAdapter" >
        </serviceTask>

        <sequenceFlow
            id="flow3"
            sourceRef="servicetask_getdataFromSDMS"
            targetRef="scripttask_chooseCalc" />

        <scriptTask
            id="scripttask_chooseCalc"
            name="Choos the Calculation Server"
            scriptFormat="groovy" >

            <script>
                execution.setVariable("calcHost", "localhost");
                execution.setVariable("calcPort", 9998);
            </script>
        </scriptTask>

        <sequenceFlow
            id="flow4"
            sourceRef="scripttask_chooseCalc"
            targetRef="servicetask_calculate" />

        <serviceTask
            id="servicetask_calculate"
            name="Calculate Result"
            activiti:class="ch.erebetez.mas.CalculationAdapter" >
        </serviceTask>

        <sequenceFlow
            id="flow5"
            sourceRef="servicetask_calculate"
            targetRef="scripttask_print" />

        <scriptTask
            id="scripttask_print"
            name="Print Report"
            scriptFormat="groovy" >

            <script>
				fielpath = 'lab_report_' + worklist + '.txt';
				
				out:println "Printing report to " + fielpath;
				
				def out = new File(fielpath);

			    out.append "Worklist " + worklist;
			    out.append '\n';

			    out.append "Dilutin factor " + dilutionFactor;
			    out.append '\n';

			    out.append "Raw data " + varB;
			    out.append '\n';
				
				out.append "Result " + varResult;
			    out.append '\n';

<!-- 			    cmdLine = "firefox " + fielpath; -->

<!-- 			    def process = cmdLine.execute(); -->
            </script>
        </scriptTask>

        <sequenceFlow
            id="flow6"
            sourceRef="scripttask_print"
            targetRef="theEnd" />

        <endEvent id="theEnd" />
    </process>

    <bpmndi:BPMNDiagram>

        <bpmndi:BPMNPlane bpmnElement="laborProcess001" >

            <bpmndi:BPMNShape bpmnElement="theStart" >

                <omgdc:Bounds
                    height="30.0"
                    width="30.0"
                    x="75.0"
                    y="225.0" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNShape bpmnElement="usertask_getdata" >

                <omgdc:Bounds
                    height="80.0"
                    width="100.0"
                    x="110.0"
                    y="200.0" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNShape bpmnElement="servicetask_getdataFromSDMS" >

                <omgdc:Bounds
                    height="80.0"
                    width="100.0"
                    x="220.0"
                    y="200.0" />
            </bpmndi:BPMNShape>
            
            <bpmndi:BPMNShape bpmnElement="scripttask_chooseCalc" >

                <omgdc:Bounds
                    height="80.0"
                    width="100.0"
                    x="330.0"
                    y="200.0" />
            </bpmndi:BPMNShape>
 
            <bpmndi:BPMNShape bpmnElement="servicetask_calculate" >

                <omgdc:Bounds
                    height="80.0"
                    width="100.0"
                    x="440.0"
                    y="200.0" />
            </bpmndi:BPMNShape>
            
            <bpmndi:BPMNShape bpmnElement="scripttask_print" >

                <omgdc:Bounds
                    height="80.0"
                    width="100.0"
                    x="550.0"
                    y="200.0" />
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="theEnd" >

                <omgdc:Bounds
                    height="28.0"
                    width="28.0"
                    x="660.0"
                    y="226.0" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge bpmnElement="flow1" >

                <omgdi:waypoint
                    x="105.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="110.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge bpmnElement="flow2" >

                <omgdi:waypoint
                    x="210.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="220.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge bpmnElement="flow3" >

                <omgdi:waypoint
                    x="310.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="320.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge bpmnElement="flow4" >

                <omgdi:waypoint
                    x="410.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="420.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>
            
             <bpmndi:BPMNEdge bpmnElement="flow5" >

                <omgdi:waypoint
                    x="510.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="520.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>   
                    
            <bpmndi:BPMNEdge bpmnElement="flow6" >

                <omgdi:waypoint
                    x="660.0"
                    y="240.0" />

                <omgdi:waypoint
                    x="660.0"
                    y="240.0" />
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>

</definitions>