<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
	xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
	xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema"
	expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.erebetez.ch/subProcess">

	<process id="doInventoryItem" name="Check a Inventory Item">

		<startEvent id="theStart" />

		<sequenceFlow id="flowfromStart" sourceRef="theStart"
			targetRef="usertask_checkInventoryItem" />

		<userTask id="usertask_checkInventoryItem" name="${itemData['lot']}"
			activiti:formKey="isItemOkForm">

			<documentation textFormat="text/plain">
				Check the Sample
			</documentation>

			<extensionElements>
				<activiti:formProperty id="isItemOk" name="IsItemOk"
					required="true" type="boolean" />
			</extensionElements>

			<potentialOwner>

				<resourceAssignmentExpression>

					<formalExpression>
						group(analysts)
					</formalExpression>
				</resourceAssignmentExpression>
			</potentialOwner>
		</userTask>

        <sequenceFlow id="flowfromInput" sourceRef="usertask_checkInventoryItem"
            targetRef="checkOosFork" />

        <inclusiveGateway id="checkOosFork" />
        
	    <sequenceFlow sourceRef="checkOosFork" targetRef="checkOosJoin" >
	         <conditionExpression xsi:type="tFormalExpression">${isItemOk == true}</conditionExpression>
	    </sequenceFlow>
	    
	    <sequenceFlow sourceRef="checkOosFork" targetRef="usertask_startOOS" >
	         <conditionExpression xsi:type="tFormalExpression">${isItemOk == false}</conditionExpression>
	    </sequenceFlow>
 
        <userTask id="usertask_startOOS" name="${itemData['lot']}"
            activiti:formKey="startOOS">

            <documentation textFormat="text/plain">
                Start a OOS Process because the sample was not ok.
            </documentation>

            <extensionElements>
                <activiti:formProperty id="oosNumber" name="OOS Number"
                    required="true" type="string" />
            </extensionElements>

            <potentialOwner>

                <resourceAssignmentExpression>

                    <formalExpression>
                        group(analysts), group(labmanagers)
                    </formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <sequenceFlow id="fromOOSstart" sourceRef="usertask_startOOS"
            targetRef="checkOosJoin" />

        <inclusiveGateway id="checkOosJoin" />

        <sequenceFlow id="flowToPrint" sourceRef="checkOosJoin"
            targetRef="scripttask_print" />

        <scriptTask id="scripttask_print" name="Print Report"
            scriptFormat="groovy">

            <script>

                fielpath = itemData['lot']  +'_ItemOut.txt';

                out:println "Printing report to " + fielpath;

                def out = new File(fielpath);

                out.append "Item " + isItemOk;
                out.append '\n';
                
                itemData.put('isItemOk', isItemOk);
                
                try {
	                out.append "OOS " + oosNumber;
	                out.append '\n';
	                
	                itemData.put('oosNumber', oosNumber);
	                
				} catch (MissingPropertyExceptionmpe) {
				    itemData.put('oosNumber', 0);		   
				}


                
                execution.setVariable("calcHost", "localhost");
                execution.setVariable("calcPort", 9998);
            </script>
        </scriptTask>

        <sequenceFlow id="flowToExtern" sourceRef="scripttask_print"
            targetRef="servicetask_externappadapter" />

        <serviceTask id="servicetask_externappadapter" name="Send Data to extern programm"
            activiti:class="ch.erebetez.activititestapp4.bpmn.services.ExternAppAdapter" >
        </serviceTask>

        <sequenceFlow id="flowToEnd" sourceRef="servicetask_externappadapter"
            targetRef="theEnd" />
            
		<endEvent id="theEnd" />


	</process>
</definitions>